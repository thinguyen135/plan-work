<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>L·∫≠p K·∫ø Ho·∫°ch & B√°o Th·ª©c</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f3f4f6;
        }
        .alarm-active {
            animation: shake 0.5s cubic-bezier(.36,.07,.19,.97) both infinite;
            border-left: 5px solid #ef4444 !important;
            background-color: #fef2f2 !important;
        }
        @keyframes shake {
            10%, 90% { transform: translate3d(-1px, 0, 0); }
            20%, 80% { transform: translate3d(2px, 0, 0); }
            30%, 50%, 70% { transform: translate3d(-4px, 0, 0); }
            40%, 60% { transform: translate3d(4px, 0, 0); }
        }
        /* Custom scrollbar */
        ::-webkit-scrollbar {
            width: 6px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f1f1; 
        }
        ::-webkit-scrollbar-thumb {
            background: #cbd5e1; 
            border-radius: 3px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #94a3b8; 
        }
    </style>
</head>
<body class="min-h-screen flex items-center justify-center p-4">

    <div class="bg-white w-full max-w-md rounded-2xl shadow-xl overflow-hidden flex flex-col h-[90vh]">
        
        <!-- Header & Clock -->
        <div class="bg-indigo-600 p-6 text-white shadow-md relative">
            <!-- N√∫t chuy·ªÉn sang trang th√∫ c∆∞ng -->
            <div class="absolute top-4 left-4">
                <a href="eat_animal.html" class="flex items-center gap-1 bg-white/20 hover:bg-white/30 px-3 py-1 rounded-full text-sm font-bold transition">
                    <i class="fas fa-paw"></i> Th√∫ c∆∞ng
                </a>
            </div>
            
            <div class="text-center pt-8">
                <h1 class="text-xl font-bold uppercase tracking-wider mb-2">L·ªãch Tr√¨nh H√¥m Nay</h1>
                <div id="clock-display" class="text-4xl font-mono font-bold tracking-widest">00:00:00</div>
                <p class="text-indigo-200 text-sm mt-1" id="date-display">ƒêang t·∫£i ng√†y...</p>
                
                <!-- Streak Section -->
                <div class="mt-4 flex items-center justify-center gap-3">
                    <div class="bg-indigo-500/30 rounded-lg px-4 py-2">
                        <span class="text-sm text-indigo-200">üî• Chu·ªói:</span>
                        <span id="streak-count" class="text-lg font-bold ml-2">0</span>
                        <span class="text-sm text-indigo-200 ml-1">ng√†y</span>
                    </div>
                    <button id="check-day-btn" onclick="checkDay()" class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-lg font-semibold transition transform hover:scale-105 flex items-center gap-2">
                        <i class="fas fa-check-circle"></i>
                        <span>ƒê√°nh d·∫•u h√¥m nay</span>
                    </button>
                </div>
                
                <!-- Th·ª©c ƒÉn hi·ªán c√≥ -->
                <div class="mt-3 text-indigo-100 text-sm">
                    <i class="fas fa-utensils mr-1"></i>
                    Th·ª©c ƒÉn: <span id="food-count">0</span>
                    <span class="text-xs ml-2">(Ho√†n th√†nh nhi·ªám v·ª• ƒë·ªÉ nh·∫≠n th√™m)</span>
                </div>
            </div>
            
            <!-- Hidden Audio Element -->
            <audio id="alarm-audio" loop preload="auto">
                <source src="luvvoice.com-20260103-l1nkyh.mp3" type="audio/mpeg">
            </audio>
        </div>

        <!-- Input Area -->
        <div class="p-4 bg-indigo-50 border-b border-indigo-100">
            <div class="flex flex-col gap-3">
                <input type="text" id="task-input" placeholder="Nh·∫≠p t√™n c√¥ng vi·ªác (VD: U·ªëng thu·ªëc, H·ªçp team...)" 
                    class="w-full px-4 py-2 rounded-lg border border-gray-300 focus:outline-none focus:border-indigo-500 focus:ring-1 focus:ring-indigo-500 transition">
                
                <div class="flex gap-2">
                    <input type="text" id="time-input" placeholder="HH:MM (VD: 08:30 ho·∫∑c 23:45)" 
                        pattern="([01]?[0-9]|2[0-3]):[0-5][0-9]"
                        class="flex-1 px-4 py-2 rounded-lg border border-gray-300 focus:outline-none focus:border-indigo-500 font-mono">
                    <button onclick="addTask()" 
                        class="bg-indigo-600 hover:bg-indigo-700 text-white px-6 py-2 rounded-lg font-semibold transition flex items-center gap-2 shadow-lg active:scale-95">
                        <i class="fas fa-plus"></i> Th√™m
                    </button>
                </div>
            </div>
        </div>

        <!-- Task List -->
        <div class="flex-1 overflow-y-auto p-4 relative">
            <ul id="task-list" class="space-y-3">
                <!-- Tasks will appear here -->
            </ul>
            
            <div id="empty-state" class="text-center text-gray-400 mt-10 hidden">
                <i class="fas fa-clipboard-list text-4xl mb-3"></i>
                <p>Ch∆∞a c√≥ k·∫ø ho·∫°ch n√†o.</p>
                <p class="text-sm mt-2">Th√™m c√¥ng vi·ªác ƒë·ªÉ nh·∫≠n th·ª©c ƒÉn cho th√∫ c∆∞ng!</p>
            </div>
        </div>

        <!-- Notification / Alarm Stop Area -->
        <div id="alarm-overlay" class="hidden absolute inset-0 bg-black/80 z-50 flex flex-col items-center justify-center text-white p-6 text-center backdrop-blur-sm">
            <i class="fas fa-bell text-6xl text-yellow-400 mb-4 animate-bounce"></i>
            <h2 class="text-3xl font-bold mb-2">H·∫øt Gi·ªù R·ªìi!</h2>
            <p id="alarm-message" class="text-xl text-gray-200 mb-8">T√™n c√¥ng vi·ªác</p>
            <button onclick="stopAlarm()" class="bg-red-500 hover:bg-red-600 text-white px-8 py-3 rounded-full text-lg font-bold shadow-lg transition transform hover:scale-105">
                <i class="fas fa-stop-circle mr-2"></i> D·ª´ng Chu√¥ng
            </button>
        </div>

        <!-- Delete Confirmation Modal -->
        <div id="delete-confirm-modal" class="hidden absolute inset-0 bg-black/80 z-50 flex flex-col items-center justify-center p-6 backdrop-blur-sm">
            <div class="bg-white rounded-2xl shadow-2xl p-8 max-w-md w-full text-center">
                <div class="mb-6">
                    <i class="fas fa-exclamation-triangle text-6xl text-red-500 mb-4"></i>
                    <h2 class="text-2xl font-bold text-gray-800 mb-2">X√°c Nh·∫≠n X√≥a</h2>
                    <p class="text-gray-600">B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a c√¥ng vi·ªác n√†y kh√¥ng?</p>
                </div>
                <div class="flex gap-4 justify-center">
                    <button onclick="cancelDelete()" class="bg-gray-300 hover:bg-gray-400 text-gray-800 px-6 py-3 rounded-lg font-semibold transition transform hover:scale-105">
                        H·ªßy
                    </button>
                    <button onclick="confirmDelete()" class="bg-red-500 hover:bg-red-600 text-white px-6 py-3 rounded-lg font-semibold transition transform hover:scale-105">
                        <i class="fas fa-trash mr-2"></i> X√≥a
                    </button>
                </div>
            </div>
        </div>

    </div>

    <script>
        // --- Variables ---
        let tasks = JSON.parse(localStorage.getItem('myDailyTasks')) || [];
        let audioContext = null;
        let alarmInterval = null;
        let isRinging = false;
        let alarmAudio = null;
        let editingIndex = -1; // Track which task is being edited
        let taskToDeleteIndex = -1; // Track which task is pending deletion
        let checkedDays = JSON.parse(localStorage.getItem('checkedDays')) || []; // Track checked days for streak

        // --- Daily persistence keys ---
        const PET_KEY = 'pet_daily_data_v1';
        const LAST_ACTIVE_DATE_KEY = 'last_active_date';
        const START_SNAPSHOT_KEY = 'start_of_day_snapshot';
        const DAILY_ARCHIVES_KEY = 'daily_archives';

        // --- Clock Logic ---
        function updateClock() {
            const now = new Date();
            const hours = String(now.getHours()).padStart(2, '0');
            const minutes = String(now.getMinutes()).padStart(2, '0');
            const seconds = String(now.getSeconds()).padStart(2, '0');
            
            document.getElementById('clock-display').innerText = `${hours}:${minutes}:${seconds}`;
            
            const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
            document.getElementById('date-display').innerText = now.toLocaleDateString('vi-VN', options);

            checkAlarms(hours, minutes, seconds);
            updateStreakDisplay();
            updateFoodCount(); // C·∫≠p nh·∫≠t s·ªë th·ª©c ƒÉn
        }

        // --- Helper Function: Normalize Time to 24h Format ---
        function normalizeTime(timeStr) {
            const match = timeStr.match(/^(\d{1,2}):(\d{2})$/);
            if (!match) return null;
            
            let hours = parseInt(match[1], 10);
            let minutes = parseInt(match[2], 10);
            
            if (hours < 0 || hours > 23 || minutes < 0 || minutes > 59) return null;
            
            hours = hours.toString().padStart(2, '0');
            minutes = minutes.toString().padStart(2, '0');
            
            return `${hours}:${minutes}`;
        }

        // --- Streak Functions ---
        function getTodayDateString() {
            const now = new Date();
            const year = now.getFullYear();
            const month = String(now.getMonth() + 1).padStart(2, '0');
            const day = String(now.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        function isTodayChecked() {
            const today = getTodayDateString();
            return checkedDays.includes(today);
        }

        function checkDay() {
            const today = getTodayDateString();
            if (!isTodayChecked()) {
                checkedDays.push(today);
                checkedDays.sort();
                localStorage.setItem('checkedDays', JSON.stringify(checkedDays));
                updateStreakDisplay();
            }
        }

        function calculateStreak() {
            if (checkedDays.length === 0) return 0;
            
            const sortedDates = [...checkedDays].sort();
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            
            let streak = 0;
            let currentDate = new Date(today);
            
            while (true) {
                const dateStr = formatDateToString(currentDate);
                if (sortedDates.includes(dateStr)) {
                    streak++;
                    currentDate.setDate(currentDate.getDate() - 1);
                } else {
                    break;
                }
            }
            
            return streak;
        }

        function formatDateToString(date) {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        function updateStreakDisplay() {
            const streak = calculateStreak();
            document.getElementById('streak-count').innerText = streak;
            
            const checkBtn = document.getElementById('check-day-btn');
            if (isTodayChecked()) {
                checkBtn.classList.add('hidden');
            } else {
                checkBtn.classList.remove('hidden');
            }
        }

        // --- C·∫≠p nh·∫≠t s·ªë th·ª©c ƒÉn t·ª´ localStorage ---
        function updateFoodCount() {
            const key = PET_KEY;
            const saved = localStorage.getItem(key);
            let foodCount = 0;
            
            if (saved) {
                try {
                    const data = JSON.parse(saved);
                    if (data.inventory && typeof data.inventory.food === 'number') {
                        foodCount = data.inventory.food;
                    }
                } catch (e) {
                    console.log('L·ªói ƒë·ªçc d·ªØ li·ªáu th√∫ c∆∞ng:', e);
                }
            }
            
            document.getElementById('food-count').innerText = foodCount;
        }

        // --- Daily snapshot & archive logic ---
        function saveStartSnapshotIfMissing() {
            const today = getTodayDateString();
            const snapshot = JSON.parse(localStorage.getItem(START_SNAPSHOT_KEY));
            if (!snapshot) {
                const petData = JSON.parse(localStorage.getItem(PET_KEY) || '{}');
                const tasksData = JSON.parse(localStorage.getItem('myDailyTasks') || '[]');
                const snap = {
                    date: today,
                    pet: petData.pet || null,
                    inventory: petData.inventory || { food: 0 },
                    tasks: tasksData,
                    timestamp: Date.now()
                };
                localStorage.setItem(START_SNAPSHOT_KEY, JSON.stringify(snap));
            }
        }

        function handleDayChangeIfNeeded() {
            const today = getTodayDateString();
            const lastDate = localStorage.getItem(LAST_ACTIVE_DATE_KEY);
            const startSnapshot = JSON.parse(localStorage.getItem(START_SNAPSHOT_KEY) || 'null');

            // First run (no lastDate): create lastDate & start snapshot
            if (!lastDate) {
                // If no snapshot, create one from current state
                saveStartSnapshotIfMissing();
                localStorage.setItem(LAST_ACTIVE_DATE_KEY, today);
                return;
            }

            if (lastDate !== today) {
                // We moved to a new day ‚Äî archive yesterday
                const petData = JSON.parse(localStorage.getItem(PET_KEY) || '{}');
                const tasksData = JSON.parse(localStorage.getItem('myDailyTasks') || '[]');

                const completedCount = tasksData.filter(t => t.completed).length;

                const archiveEntry = {
                    date: lastDate,
                    startSnapshot: startSnapshot || null,
                    endSnapshot: {
                        pet: petData.pet || null,
                        inventory: petData.inventory || { food: 0 }
                    },
                    tasks: tasksData,
                    completedCount: completedCount,
                    archivedAt: Date.now()
                };

                // Push to daily_archives
                const archives = JSON.parse(localStorage.getItem(DAILY_ARCHIVES_KEY) || '[]');
                archives.push(archiveEntry);
                localStorage.setItem(DAILY_ARCHIVES_KEY, JSON.stringify(archives));

                // Reset daily flags on tasks only (do not remove tasks list)
                const resetTasks = tasksData.map(t => ({ ...t, completed: false, rang: false }));
                tasks = resetTasks;
                localStorage.setItem('myDailyTasks', JSON.stringify(tasks));

                // Update UI
                renderTasks();

                // Save new start snapshot for today (after reset)
                const newStartSnap = {
                    date: today,
                    pet: petData.pet || null,
                    inventory: petData.inventory || { food: 0 },
                    tasks: resetTasks,
                    timestamp: Date.now()
                };
                localStorage.setItem(START_SNAPSHOT_KEY, JSON.stringify(newStartSnap));
                // Update last active date
                localStorage.setItem(LAST_ACTIVE_DATE_KEY, today);

                // Optional: keep archives list length manageable (e.g., last 30 days)
                // const MAX_ARCHIVES = 60;
                // if (archives.length > MAX_ARCHIVES) archives.splice(0, archives.length - MAX_ARCHIVES);
                // localStorage.setItem(DAILY_ARCHIVES_KEY, JSON.stringify(archives));
            } else {
                // same day; ensure snapshot exists
                saveStartSnapshotIfMissing();
            }
        }

        // --- Initialize daily persistence on load & each minute to catch day boundary ---
        setInterval(() => {
            // check once per minute for day rollover
            handleDayChangeIfNeeded();
        }, 60 * 1000);

        // --- Start check immediately on load ---
        handleDayChangeIfNeeded();

        // --- Task Management ---
        function renderTasks() {
            const list = document.getElementById('task-list');
            const emptyState = document.getElementById('empty-state');
            
            list.innerHTML = '';
            
            // Sort tasks by time
            tasks.sort((a, b) => a.time.localeCompare(b.time));

            if (tasks.length === 0) {
                emptyState.classList.remove('hidden');
            } else {
                emptyState.classList.add('hidden');
                tasks.forEach((task, index) => {
                    const li = document.createElement('li');
                    li.className = `bg-white p-3 rounded-lg shadow-sm border-l-4 ${task.completed ? 'border-green-500 opacity-60' : 'border-indigo-500'} flex justify-between items-center group transition hover:shadow-md`;
                    
                    const now = new Date();
                    const currentHM = String(now.getHours()).padStart(2, '0') + ":" + String(now.getMinutes()).padStart(2, '0');
                    const isPast = task.time < currentHM && !task.completed;

                    if (editingIndex === index) {
                        li.innerHTML = `
                            <div class="flex-1 flex flex-col gap-2">
                                <input type="text" id="edit-time-${index}" value="${task.time}" 
                                    placeholder="HH:MM (24h)"
                                    pattern="([01]?[0-9]|2[0-3]):[0-5][0-9]"
                                    class="px-3 py-2 rounded-lg border border-indigo-500 focus:outline-none focus:ring-2 focus:ring-indigo-500 font-mono text-lg font-bold">
                                <input type="text" id="edit-name-${index}" value="${task.name}" 
                                    placeholder="T√™n c√¥ng vi·ªác" 
                                    class="px-3 py-2 rounded-lg border border-indigo-500 focus:outline-none focus:ring-2 focus:ring-indigo-500">
                            </div>
                            <div class="flex gap-2 ml-3">
                                <button onclick="saveTask(${index})" class="bg-green-500 hover:bg-green-600 text-white px-3 py-2 rounded-lg transition" title="L∆∞u">
                                    <i class="fas fa-check"></i>
                                </button>
                                <button onclick="cancelEdit()" class="bg-gray-400 hover:bg-gray-500 text-white px-3 py-2 rounded-lg transition" title="H·ªßy">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                        `;
                    } else {
                        li.innerHTML = `
                            <div class="flex flex-col">
                                <span class="text-2xl font-mono font-bold text-gray-700 ${task.completed ? 'line-through' : ''}">${task.time}</span>
                                <span class="text-gray-600 font-medium ${task.completed ? 'line-through' : ''}">${task.name}</span>
                                ${isPast ? '<span class="text-xs text-red-400 mt-1">ƒê√£ qua gi·ªù</span>' : ''}
                                ${task.completed ? '<span class="text-xs text-green-500 mt-1"><i class="fas fa-utensils mr-1"></i>ƒê√£ nh·∫≠n th·ª©c ƒÉn</span>' : ''}
                            </div>
                            <div class="flex gap-2 opacity-100 sm:opacity-0 group-hover:opacity-100 transition-opacity">
                                <button onclick="editTask(${index})" class="text-gray-400 hover:text-blue-500 p-2" title="S·ª≠a">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button onclick="toggleComplete(${index})" class="text-gray-400 hover:text-green-500 p-2" title="Ho√†n th√†nh">
                                    <i class="fas ${task.completed ? 'fa-undo' : 'fa-check'}"></i>
                                </button>
                                <button onclick="deleteTask(${index})" class="text-gray-400 hover:text-red-500 p-2" title="X√≥a">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        `;
                    }
                    list.appendChild(li);
                });
            }
            localStorage.setItem('myDailyTasks', JSON.stringify(tasks));
        }

        function addTask() {
            initAudio();

            const nameInput = document.getElementById('task-input');
            const timeInput = document.getElementById('time-input');
            
            const name = nameInput.value.trim();
            const time = timeInput.value.trim();

            if (!name) {
                alert("Vui l√≤ng nh·∫≠p t√™n c√¥ng vi·ªác!");
                return;
            }
            if (!time) {
                alert("Vui l√≤ng ch·ªçn th·ªùi gian!");
                return;
            }

            const normalizedTime = normalizeTime(time);
            if (!normalizedTime) {
                alert("Th·ªùi gian kh√¥ng h·ª£p l·ªá! Vui l√≤ng nh·∫≠p theo ƒë·ªãnh d·∫°ng 24h, v√≠ d·ª•: 08:30 ho·∫∑c 23:45");
                return;
            }

            tasks.push({
                name: name,
                time: normalizedTime,
                completed: false,
                rang: false // Track if alarm has rung for this task
            });

            nameInput.value = '';
            timeInput.value = '';
            renderTasks();
        }

        function deleteTask(index) {
            taskToDeleteIndex = index;
            document.getElementById('delete-confirm-modal').classList.remove('hidden');
        }

        function confirmDelete() {
            if (taskToDeleteIndex >= 0) {
                const index = taskToDeleteIndex;
                if (editingIndex === index) {
                    editingIndex = -1;
                } else if (editingIndex > index) {
                    editingIndex--;
                }
                tasks.splice(index, 1);
                renderTasks();
                taskToDeleteIndex = -1;
            }
            document.getElementById('delete-confirm-modal').classList.add('hidden');
        }

        function cancelDelete() {
            taskToDeleteIndex = -1;
            document.getElementById('delete-confirm-modal').classList.add('hidden');
        }

        function grantFood() {
            const key = PET_KEY;
            const saved = localStorage.getItem(key);
            if (saved) {
                try {
                    const data = JSON.parse(saved);
                    if (!data.inventory || typeof data.inventory.food !== 'number') {
                        data.inventory = { food: 0 };
                    }
                    data.inventory.food += 1;
                    localStorage.setItem(key, JSON.stringify(data));
                    
                    showFoodNotification();
                } catch (e) {
                    console.log('L·ªói khi th√™m th·ª©c ƒÉn:', e);
                }
            } else {
                const pet = {
                    name: 'Pet',
                    level: 1,
                    exp: 0,
                    hunger: 80,
                    happiness: 80,
                    type: 'cat',
                    stage: 'egg',
                    bornDate: Date.now()
                };
                const inventory = { food: 1 };
                const tasksInit = [
                    { id: 1, text: 'U·ªëng m·ªôt c·ªëc n∆∞·ªõc', completed: false },
                    { id: 2, text: 'ƒê·ªçc s√°ch 15 ph√∫t', completed: false }
                ];
                localStorage.setItem(key, JSON.stringify({ pet, inventory, tasks: tasksInit }));
                
                showFoodNotification();
            }
            
            updateFoodCount();
        }

        function showFoodNotification() {
            const notification = document.createElement('div');
            notification.className = 'fixed top-4 right-4 bg-green-500 text-white px-4 py-2 rounded-lg shadow-lg z-50 animate-bounce';
            notification.innerHTML = `
                <div class="flex items-center gap-2">
                    <i class="fas fa-utensils"></i>
                    <span>+1 Th·ª©c ƒÉn cho th√∫ c∆∞ng!</span>
                </div>
            `;
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.remove();
            }, 3000);
        }

        function toggleComplete(index) {
            const wasCompleted = tasks[index].completed;
            tasks[index].completed = !wasCompleted;
            if (!wasCompleted && tasks[index].completed) {
                grantFood();
            }
            renderTasks();
        }

        function editTask(index) {
            editingIndex = index;
            renderTasks();
            setTimeout(() => {
                const nameInput = document.getElementById(`edit-name-${index}`);
                if (nameInput) nameInput.focus();
            }, 50);
        }

        function saveTask(index) {
            const nameInput = document.getElementById(`edit-name-${index}`);
            const timeInput = document.getElementById(`edit-time-${index}`);
            
            const newName = nameInput.value.trim();
            const newTime = timeInput.value.trim();

            if (!newName) {
                alert("Vui l√≤ng nh·∫≠p t√™n c√¥ng vi·ªác!");
                return;
            }
            if (!newTime) {
                alert("Vui l√≤ng ch·ªçn th·ªùi gian!");
                return;
            }

            const normalizedTime = normalizeTime(newTime);
            if (!normalizedTime) {
                alert("Th·ªùi gian kh√¥ng h·ª£p l·ªá! Vui l√≤ng nh·∫≠p theo ƒë·ªãnh d·∫°ng 24h, v√≠ d·ª•: 08:30 ho·∫∑c 23:45");
                return;
            }

            tasks[index].name = newName;
            tasks[index].time = normalizedTime;
            tasks[index].rang = false;

            editingIndex = -1;
            renderTasks();
        }

        function cancelEdit() {
            editingIndex = -1;
            renderTasks();
        }

        // --- Alarm Logic & Audio ---
        function initAudio() {
            if (!alarmAudio) {
                alarmAudio = document.getElementById('alarm-audio');
                alarmAudio.load();
            }
        }

        window.addEventListener('load', () => {
             alarmAudio = document.getElementById('alarm-audio');
             initAudio();
             renderTasks();
             updateStreakDisplay();
             updateFoodCount();

             // Ensure daily snapshot exists / handle day change at load time
             handleDayChangeIfNeeded();
             setInterval(updateClock, 1000);
             updateClock(); // ch·∫°y ngay l·∫ßn ƒë·∫ßu

        });

        function playAlarmSound() {
            if (!alarmAudio) initAudio();
            try {
                alarmAudio.currentTime = 0;
                alarmAudio.play().catch(err => {
                    console.log('Cannot play audio:', err);
                    initAudio();
                });
            } catch (error) {
                console.error('Error playing alarm sound:', error);
            }
        }

        function checkAlarms(hours, minutes, seconds) {
            if (isRinging) return;

            const currentTimeStr = `${hours}:${minutes}`;

            // S·ª¨A ƒê·ªîI: B·ªè ƒëi·ªÅu ki·ªán seconds == '00'
            // Ch·ªâ c·∫ßn ƒë√∫ng gi·ªù:ph√∫t v√† ch∆∞a k√™u (rang == false) l√† ƒë∆∞·ª£c
            const taskToRing = tasks.find(t => 
                t.time === currentTimeStr && 
                !t.completed && 
                !t.rang
            );

            if (taskToRing) {
                triggerAlarm(taskToRing);
            }
        }

        function triggerAlarm(task) {
            isRinging = true;
            task.rang = true;
            localStorage.setItem('myDailyTasks', JSON.stringify(tasks));
            
            document.getElementById('alarm-message').innerText = task.name;
            document.getElementById('alarm-overlay').classList.remove('hidden');

            playAlarmSound();

            if (Notification.permission === "granted") {
                new Notification("ƒê·∫øn gi·ªù: " + task.name);
            } else if (Notification.permission !== "denied") {
                Notification.requestPermission().then(permission => {
                    if (permission === "granted") {
                        new Notification("ƒê·∫øn gi·ªù: " + task.name);
                    }
                });
            }
        }

        function stopAlarm() {
            isRinging = false;
            clearInterval(alarmInterval);
            
            if (alarmAudio) {
                alarmAudio.pause();
                alarmAudio.currentTime = 0;
            }
            
            document.getElementById('alarm-overlay').classList.add('hidden');
        }

        if ("Notification" in window) {
            Notification.requestPermission();
        }
    </script>
</body>
</html>
